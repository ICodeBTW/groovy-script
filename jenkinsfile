pipeline {
    agent any
    
    environment {
        BEBE="This is envi"  
    }

    stages {
        stage("Test"){
            steps{

            script{              
                    env.Works = "This works lolol"
                }            
             }
        }
        stage("ansible deploy")
        {

            steps{
                script{
                sh """ 

                    ansible-playbook ansible/customgroovy.yaml
                """
            }
            }

        }
        stage('Email Test') {
            
            steps {
                echo 'Hello World'
                script{
                env.BEBE = "Sadge works only from here :/"
                 emailext body: '''${SCRIPT, template="sample-groovy-new.template"}''',  subject: 'test1',  saveOutput: true
                // env.body = '''${SCRIPT, template="groovy-html.template"}'''
                // sh "echo ${env.body}"
                sh """ cat Always-\${BUILD_NUMBER}.txt """
                    
                }
            }
        }

        stage('Testing for failed email') {
            steps {
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                    sh "exit 1"
                }
                 emailext body: '''${SCRIPT, template="sample-groovy-new.template"}''',  subject: 'test1',  saveOutput: true
                sh """ cat Always-\${BUILD_NUMBER}.txt """
            }
        }
        
    }
}

